- content_for :title, "Activiteit #{@activity.title} - SOFIA"

.container.footer-padding
  .row.justify-content-between
    .col-sm-12.col-md-6.py-2

      h1 = fa_icon 'calendar', class: 'mr-2', text: @activity.title

      table.table.table-sm
        tbody
          tr
            th scope='row' = 'Starttijd'
            td = l @activity.start_time, format: :long
          tr
            th scope='row' = 'Eindtijd'
            td = l @activity.end_time, format: :long
          tr
            th scope='row' = 'Vergrendelt op'
            td = l @activity.lock_date, format: :long
          tr
            th scope='row' = 'Prijslijst'
            td = @price_list.name
          tr
            th scope='row' = 'Gemaakt door'
            td = @activity.created_by.name
          tr
            th scope='row' = 'Tappers'
            td = @bartenders.map(&:name).join(', ')

    .card.col-sm-12.col-md-6.col-lg-4.py-2.align-self-start
      .card-body
        h2.card-title = 'Streepscherm'

        - if @activity.locked?
          .card-text
            div class='alert alert-danger'
              = 'Deze activiteit is langer dan een maand geleden afgelopen. Er kunnen geen nieuwe '
              = 'bestellingen worden geplaatst en geen saldocorrecties meer worden toegevoegd'
        - else
          p.card-text = 'Je kan bestellingen plaatsen in het streepscherm.'

          = link_to order_screen_activity_url(@activity), class: 'btn btn-primary btn-block'
            = 'Naar het streepscherm'
            = fa_icon 'calculator', class: 'ml-1'

  hr

  .row
    .col-sm-12
      ul.nav.nav-tabs role='tablist' id='activityTabs'
        li.nav-item
          a.nav-link.active (id='summary-tab' data-toggle="tab" href="#summary" role="tab"
            aria-controls="summary" aria-selected="true")
            = 'Samenvatting'
        li.nav-item
          a.nav-link (id='credit_mutations-tab' data-toggle="tab" href="#credit_mutations" role="tab"
            aria-controls="credit_mutations" aria-selected="false")
            = 'Inleg en correcties'
        - if current_user.treasurer?
          li.nav-item
            a.nav-link (id='orders-tab' data-toggle="tab" href="#orders" role="tab"
              aria-controls="orders" aria-selected="false")
              = 'Bestellingen'
        li.nav-item
          a.nav-link (id='product_totals-tab' data-toggle="tab" href="#product_totals" role="tab"
            aria-controls="product_totals-tab" aria-selected="false")
            = 'Producttotalen'

      .tab-content.p-2 id='activityTabsContent'
        .tab-pane.show.active id='summary' role='tabpanel' aria-labelledby='summary-tab'
          .row.justify-content-between
            - if @credit_mutations.empty? && @orders.empty?
              .table-responsive
                table.table.table-striped
                  tbody
                    tr
                      td.text-center colspan='4'
                        p.my-1
                          em = 'Er zijn nog geen bestellingen en er is nog niet ingelegd'
            - else
              .col-12.col-md-6
                table.table.table-sm
                  thead
                    tr
                      th scope='col' = 'Resultaat'
                      th scope='col' = 'Code'
                      th.text-right scope='col' = 'Credit'
                  tbody
                    - Product.categories.each do |category|
                      tr
                        td = t(category.first).capitalize
                        td = t("codes.#{category.first}")
                        td.text-right
                          = number_to_currency(@revenue_by_category[category[0]] || 0, unit: '€')
                    tr
                      th.pl-4 scope='row' = 'Totaal opbrengsten'
                      td
                      td.text-right
                        strong = number_to_currency(@revenue_total, unit: '€')

              .col-12.col-md-5
                table.table.table-sm
                  thead
                    tr
                      th scope='col' = 'Balans'
                      th scope='col' = 'Code'
                      th.text-right scope='col' = 'Credit'
                      th.text-right scope='col' = 'Debit'
                  tbody
                    tr
                      td = 'Inleg Zatladder Inlegsysteem'
                      td = t('codes.credit_mutation')
                      td.text-right
                        = number_to_currency(@credit_mutations_total, unit: '€')
                      td
                    tr
                      td = 'Contante bestellingen'
                      td
                      td.text-right = number_to_currency(@revenue_with_cash, unit: '€')
                      td
                    tr
                      td title="Contante inleg plus contante betalingen"
                        strong = 'Totaal kas'
                      td = t('codes.cash')
                      td
                      td.text-right = number_to_currency(@cash_total, unit: '€')
                    tr
                      td = 'Omzet Pin'
                      td = t('codes.pin')
                      td
                      td.text-right = number_to_currency(@revenue_with_pin, unit: '€')
                    tr
                      td = 'Kosten Pin'
                      td = t('codes.pin_fee')
                      td
                      td.text-right = number_to_currency(@pin_transaction_fee, unit: '€')
                    tr
                      td = 'Omzet Zatladder Inlegsysteem'
                      td = t('codes.credit_mutation')
                      td
                      td.text-right = number_to_currency(@revenue_with_credit, unit: '€')

        .tab-pane id='credit_mutations' role='tabpanel' aria-labelledby='credit_mutations-tab'
          .table-responsive
            table.table.table-striped
              - if @credit_mutations.empty?
                tr
                  td.text-center colspan='4'
                    p.my-1
                      em = 'Er zijn nog geen correcties en er is nog niet ingelegd'
              - else
                thead
                  tr
                    th scope='col' = '#'
                    th scope='col' = 'Tijd'
                    th scope='col' = 'Gebruiker'
                    th scope='col' = 'Bedrag'
                tbody
                  - @credit_mutations.each do |mutation|
                    tr
                      th scope='row' = mutation.id
                      td = l mutation.created_at, format: :time_only
                      td = link_to mutation.user.name, mutation.user
                      td = number_to_currency(mutation.amount, unit: '€')

        - if current_user.treasurer?
          .tab-pane id='orders' role='tabpanel' aria-labelledby='orders-tab'
            .table-responsive
              table.table.table-striped
                - if @orders.empty?
                  tr
                    td.text-center colspan='4'
                      p.my-1
                        em = 'Er zijn nog geen bestellingen'
                - else
                  thead
                    tr
                      th scope='col' = '#'
                      th scope='col' = 'Tijd'
                      th scope='col' = 'Gebruiker'
                      th scope='col' = 'Bedrag'
                      th scope='col' = 'Producten'

                  tbody
                    - @orders.each do |order|
                      tr
                        th scope='row' = order.id
                        td = l order.created_at, format: :time_only
                        td
                          - if order.user.present?
                            = link_to order.user.name, order.user
                          - if order.paid_with_pin
                            em = 'Gepind'
                          - if order.paid_with_cash
                            em = 'Contant betaald'
                        td = number_to_currency(order.order_total, unit: '€')
                        td
                          - order.order_rows.each_with_index do |order_row, i|
                            = order_row.product.name
                            - if order_row.product_count > 1
                              = " (#{order_row.product_count}x)"
                            - if i < order.order_rows.size - 1
                              = ', '

        .tab-pane id='product_totals' role='tabpanel' aria-labelledby='product_totals-tab'
          .row
            .col-6.mx-auto
              .table-responsive
                table.table.table-sm
                  - if @count_per_product.empty?
                    tr
                      td.text-center colspan='4'
                        p.my-1
                          em = 'Er zijn geen producten verkocht'
                  - else
                    thead
                      tr
                        th scope='col' = 'Product'
                        th.text-right scope='col' = 'Aantal keer besteld'

                    tbody
                      - @count_per_product.each do |product, sum|
                        tr
                          th scope='row' = product.name
                          td.text-right = "#{sum} x"
